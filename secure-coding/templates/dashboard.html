{% extends "base.html" %}
{% block title %}대시보드{% endblock %}
{% block content %}
<h2>대시보드</h2>
<p>보유 캐시: {{ user.cash }}원</p>

<div class="search-container">
    <form id="searchForm">
        <div class="search-input-group">
            <input type="text" id="searchInput" placeholder="상품명 또는 판매자명으로 검색">
            <button type="submit">검색</button>
        </div>
    </form>
</div>

<h3>등록된 상품</h3>
<div id="productsList">
    <ul>
    {% for product in products %}
        <li>
            <a href="{{ url_for('view_product', product_id=product.id) }}" style="text-decoration: none;">
                <span class="product-title">{{ product.title }}</span>
            </a>
            - 가격: {{ product.price }}원
            - 판매자: <span class="seller-name" data-username="{{ product.seller_username }}">{{ product.seller_username }}</span>
            {% if product.sold_status == 1 %}
                - 판매상태: <span class="status-sold">판매완료</span>
            {% else %}
                - 판매상태: <span class="status-available">판매중</span>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
</div>
<p><a href="{{ url_for('new_product') }}">새 상품 등록</a></p>

<h3>실시간 채팅</h3>
<div id="chat">
    <ul id="messages"></ul>
    <div class="chat-input-container">
        <input id="chat_input" type="text" placeholder="메시지를 입력하세요" onkeypress="if(event.keyCode==13) sendMessage()">
        <button onclick="sendMessage()">전송</button>
    </div>
</div>

<style>
.search-container {
    margin: 20px 0;
}

.search-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.search-input-group input[type="text"] {
    width: 30%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.search-input-group button {
    padding: 8px 16px;
    width: 80px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.search-input-group button:hover {
    background-color: #45a049;
}

#productsList ul {
    list-style: none;
    padding: 0;
}

#productsList li {
    padding: 10px;
    border-bottom: 1px solid #eee;
}

#productsList li:last-child {
    border-bottom: none;
}

.chat-input-container {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.chat-input-container input {
    flex: 1;
    margin-bottom: 0;
}

.chat-input-container button {
    width: auto;
    margin-bottom: 0;
}

.seller-name {
    cursor: pointer;
}

.seller-name:hover {
    text-decoration: underline;
}

.status-sold {
    color: #ff4444;
}

.status-available {
    color: #007AFF;
}
</style>

<script type="text/javascript">
document.getElementById('searchForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const searchValue = document.getElementById('searchInput').value;
    
    fetch('/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ search: searchValue })
    })
    .then(response => response.json())
    .then(data => {
        const productsList = document.getElementById('productsList');
        if (data.products.length === 0) {
            productsList.innerHTML = '<p>검색 결과가 없습니다.</p>';
            return;
        }
        
        let html = '<ul>';
        data.products.forEach(product => {
            html += `
                <li>
                    <a href="/product/${product.id}" style="text-decoration: none;">
                        <span class="product-title">${product.title}</span>
                    </a>
                    - 가격: ${product.price}원
                    - 판매자: <span class="seller-name" data-username="${product.seller_username}">${product.seller_username}</span>
                    - <span class="${product.sold_status ? 'status-sold' : 'status-available'}">판매상태: ${product.sold_status ? '판매완료' : '판매중'}</span>
                </li>
            `;
        });
        html += '</ul>';
        productsList.innerHTML = html;
        addSellerClickEvents();
    })
    .catch(error => console.error('Error:', error));
});

function addSellerClickEvents() {
    document.querySelectorAll('.seller-name').forEach(seller => {
        seller.addEventListener('click', function() {
            const username = this.dataset.username;
            document.getElementById('searchInput').value = username;
            document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        });
    });
}

// 초기 판매자 클릭 이벤트 추가
addSellerClickEvents();

var socket = io();
socket.on('connect', function() {
    console.log("채팅 서버에 연결됨");
});
socket.on('message', function(data) {
    var messages = document.getElementById('messages');
    var item = document.createElement('li');
    item.textContent = data.username + ": " + data.message;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
});
function sendMessage() {
    var input = document.getElementById('chat_input');
    var message = input.value;
    if (message) {
        socket.emit('send_message', { 'username': "{{ user.username }}", 'message': message });
        input.value = "";
    }
}
</script>
{% endblock %}
